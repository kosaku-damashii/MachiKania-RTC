REM RTC.BAS
REM RTC-4543SA

USEVAR SEC,MIN,HOUR,DATE,DAY,MONTH,YEAR

GOSUB RTCINT

SEC=00
MIN=06
HOUR=21
DAY=16
MONTH=2
YEAR=20

DATE=GOSUB(SETDTE)

GOSUB WRRTC

WAIT 60

WHILE 1
  GOSUB RDRTC
  PRINT DEC$(YEAR)+" "+DEC$(MONTH)+"/"+DEC$(DAY)+" "+DEC$(HOUR)+":"+DEC$(MIN)+":"+DEC$(SEC)+" "+DEC$(DATE)
  WAIT 60
WEND

END

LABEL WAITu
  USETIMER ARGS(1)
  WHILE TIMER() > 0
  WEND
RETURN

LABEL SETDTE
  VAR Y,M
  IF ((MONTH = 1) OR (MONTH = 2)) THEN
    Y=(YEAR+2000)-1
    M=MONTH+12
  ENDIF
RETURN (Y+Y/4-Y/100+Y/400+(13*M+8)/5+DAY)%7+1

LABEL RTCIDL
  OUT 17,0    REM E6  CE
  OUT 14,0    REM B14 WR
  OUT 15,0    REM B15 CLK
  OUT 16,0    REM E5  DATA
RETURN

LABEL RTCWRM
  OUT 14,1    REM B14 WR
  OUT 17,1    REM E6  CE
RETURN

LABEL RTCRDM
  OUT 14,0    REM B14 WR
  OUT 17,1    REM E6  CE
RETURN

LABEL CLK
  OUT 15,1    REM B15 CLK
  GOSUB WAITu, 500
  OUT 15,0    REM B15 CLK
  GOSUB WAITu, 500
RETURN

LABEL SETBIT
  IF (ARGS(1) AND 1) = 1 THEN
    OUT 16,1   REM E5  DATA
  ELSE
    OUT 16,0   REM E5  DATA
  ENDIF
  GOSUB CLK
RETURN

LABEL RDBIT
  GOSUB CLK
RETURN IN(16) AND 1 

LABEL SETDAT
  VAR A,B,I
  A=ARGS(1)
  B=ARGS(2)
  FOR I=0 TO B-1
    GOSUB SETBIT, (A AND 1)
    A=A >> 1
  NEXT
  WAIT 1
RETURN

LABEL RDDAT
  VAR A,B,T,I
  A=ARGS(1)
  B=0
  T=0
  FOR I=0 TO A-1
    T=GOSUB(RDBIT)
    T=T << I
    B=B+T
  NEXT
RETURN B

LABEL RTCINT
  SEC=0
  MIN=0
  HOUR=0
  DATE=0
  DAY=0
  MONTH=0
  YEAR=0
RETURN

LABEL WRRTC
  GOSUB RTCWRM

  GOSUB SETDAT,SEC % 10,4
  GOSUB SETDAT,SEC / 10,3
  GOSUB SETDAT,0,1   REM FDT bit(always set 0)

  GOSUB SETDAT,MIN % 10,4
  GOSUB SETDAT,MIN / 10,3
  GOSUB SETDAT,0,1   REM user bit(0)

  GOSUB SETDAT,HOUR % 10,4
  GOSUB SETDAT,HOUR / 10,2
  GOSUB SETDAT,0,2   REM user bit(0)

  GOSUB SETDAT,DATE,3
  GOSUB SETDAT,0,1   REM user bit(0)

  GOSUB SETDAT,DAY % 10,4
  GOSUB SETDAT,DAY / 10,2
  GOSUB SETDAT,0,2   REM user bit(0)

  GOSUB SETDAT,MONTH % 10,4
  GOSUB SETDAT,MONTH / 10,1
  GOSUB SETDAT,0,2   REM user bit(0)
  GOSUB SETDAT,0,1   REM TM bit(always set 0)

  GOSUB SETDAT,YEAR % 10,4
  GOSUB SETDAT,YEAR / 10,4

  GOSUB RTCIDL
RETURN

LABEL RDRTC
  VAR A,B
  GOSUB RTCRDM

  A=GOSUB(RDDAT,4)
  B=GOSUB(RDDAT,3)
  SEC=A + (B * 10)
  A=GOSUB(RDDAT,1)   REM FDT bit

  A=GOSUB(RDDAT,4)
  B=GOSUB(RDDAT,3)
  MIN=A + (B * 10)
  A=GOSUB(RDDAT,1)   REM user bit

  A=GOSUB(RDDAT,4)
  B=GOSUB(RDDAT,2)
  HOUR=A + (B * 10)
  A=GOSUB(RDDAT,2)   REM user bit

  DATE=GOSUB(RDDAT,3)
  A=GOSUB(RDDAT,1)   REM user bit

  A=GOSUB(RDDAT,4)
  B=GOSUB(RDDAT,2)
  DAY=A + (B * 10)
  A=GOSUB(RDDAT,2)   REM user bit

  A=GOSUB(RDDAT,4)
  B=GOSUB(RDDAT,1)
  MONTH=A + (B * 10)
  A=GOSUB(RDDAT,2)   REM user bit
  A=GOSUB(RDDAT,1)   REM TM bit

  A=GOSUB(RDDAT,4)
  B=GOSUB(RDDAT,4)
  YEAR=A + (B * 10)

  GOSUB RTCIDL
RETURN
